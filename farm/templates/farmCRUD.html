<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token }}">

    <title>Farm Management System</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .farm-card {
            transition: transform 0.3s;
            margin-bottom: 20px;
        }
        .farm-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .action-buttons {
            display: flex;
            gap: 10px;
        }
        .page-header {
            background-color: #f8f9fa;
            padding: 20px 0;
            margin-bottom: 30px;
            border-bottom: 1px solid #e9ecef;
        }
        .empty-state {
            text-align: center;
            padding: 40px 0;
        }
        .form-section {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 30px;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="page-header">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <h1><i class="fas fa-tractor me-2"></i>Farm Management</h1>
                <button id="addFarmBtn" class="btn btn-primary">
                    <i class="fas fa-plus me-2"></i>Add New Farm
                </button>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Alert Messages -->
        <div id="alertContainer"></div>

        <!-- Add/Edit Farm Form -->
        <div id="farmFormContainer" class="form-section mb-4" style="display: none;">
            <h3 id="formTitle">Add New Farm</h3>
            <form id="farmForm">
                <input type="hidden" id="farmId">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="name" class="form-label">Farm Name</label>
                        <input type="text" class="form-control" id="name" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="location" class="form-label">Location</label>
                        <input type="text" class="form-control" id="location" required>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="area" class="form-label">Area (acres)</label>
                        <input type="number" step="0.01" class="form-control" id="area" required>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="farmType" class="form-label">Farm Type</label>
                        <input type="text" class="form-control" id="farmType">
                    </div>
                </div>
                <div class="d-flex justify-content-end gap-2">
                    <button type="button" id="cancelForm" class="btn btn-secondary">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Farm</button>
                </div>
            </form>
        </div>

        <!-- Farms List Section -->
        <div class="row" id="farmsList">
            <!-- Farms will be loaded here -->
            <div class="col-12 empty-state" id="emptyState">
                <div class="text-center">
                    <i class="fas fa-seedling fa-4x text-muted mb-3"></i>
                    <h3>No Farms Found</h3>
                    <p class="text-muted">Create your first farm by clicking the "Add New Farm" button above.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    Are you sure you want to delete <span id="deleteFarmName"></span>? This action cannot be undone.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDelete">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Farm Details Modal -->
    <div class="modal fade" id="detailsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="detailsFarmName">Farm Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Location:</strong> <span id="detailsLocation"></span></p>
                            <p><strong>Area:</strong> <span id="detailsArea"></span> acres</p>
                            <p><strong>Farm Type:</strong> <span id="detailsType"></span></p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Created:</strong> <span id="detailsCreated"></span></p>
                            <p><strong>Last Updated:</strong> <span id="detailsUpdated"></span></p>
                        </div>
                    </div>

                    <hr>
                    <h5>Motors</h5>
                    <div id="motorsList">
                        <p class="text-muted" id="noMotorsMessage">No motors associated with this farm.</p>
                        <div id="motorsContent"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>

        $(document).ready(function() {
            const token = localStorage.getItem("authToken");
            console.log("Stored Token:", localStorage.getItem("authToken"));
            function getCSRFToken() {
                return document.querySelector('meta[name="csrf-token"]').getAttribute('content');
            }


            // Global variables
            let deleteId = null;
            const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
            const detailsModal = new bootstrap.Modal(document.getElementById('detailsModal'));

            // API base URL - All farm API endpoints are under this prefix
            const API_BASE_URL = '/farm/';

            // Load farms on page load
            loadFarms();

            // Add Farm button click handler
            $('#addFarmBtn').click(function() {
                showFormForAdd();
            });

            // Cancel form button click handler
            $('#cancelForm').click(function() {
                hideForm();
            });

            // Farm form submit handler
            $('#farmForm').submit(function(e) {
                e.preventDefault();
                saveFarm();
            });

            // Confirm delete button click handler
            $('#confirmDelete').click(function() {
                if (deleteId) {
                    deleteFarm(deleteId);
                }
            });

            // Function to load all farms
            function loadFarms() {
                $.ajax({
                    url: API_BASE_URL + 'farmlist/',
                    type: 'GET',
                    headers: {
                        'Authorization': 'Token 5cd647b01e7b4f5abf5b509176e0b72528c3088f',
                        'Content-Type': 'application/json',
                         'X-CSRFToken': 'cilZR9GCqnExakLXfs5g9NvGCnfrzHiA',
                         'Accept': 'application/json'
                    },
                    success: function(data) {
                        renderFarms(data);
                    },
                    error: function(xhr) {
                        showAlert('Error loading farms: ' + getErrorMessage(xhr), 'danger');
                    }
                });
            }

            // Function to render farms in UI
            function renderFarms(farms) {
                const farmsList = $('#farmsList');
                farmsList.empty();

                if (farms.length === 0) {
                    $('#emptyState').show();
                    return;
                }

                $('#emptyState').hide();

                farms.forEach(function(farm) {
                    const farmCard = `
                        <div class="col-md-4">
                            <div class="card farm-card">
                                <div class="card-body">
                                    <h5 class="card-title">${farm.name}</h5>
                                    <p class="card-text">
                                        <i class="fas fa-map-marker-alt me-1"></i> ${farm.location}<br>
                                        <i class="fas fa-ruler-combined me-1"></i> ${farm.area} acres<br>
                                        <i class="fas fa-tag me-1"></i> ${farm.farm_type || 'Not specified'}
                                    </p>
                                    <div class="action-buttons">
                                        <button class="btn btn-sm btn-info view-farm" data-id="${farm.id}">
                                            <i class="fas fa-eye"></i> View
                                        </button>
                                        <button class="btn btn-sm btn-warning edit-farm" data-id="${farm.id}">
                                            <i class="fas fa-edit"></i> Edit
                                        </button>
                                        <button class="btn btn-sm btn-danger delete-farm" data-id="${farm.id}" data-name="${farm.name}">
                                            <i class="fas fa-trash"></i> Delete
                                        </button>
                                    </div>
                                </div>
                                <div class="card-footer text-muted">
                                    <small>Last updated: ${formatDate(farm.updated_at)}</small>
                                </div>
                            </div>
                        </div>
                    `;
                    farmsList.append(farmCard);
                });

                // Attach event handlers to buttons
                $('.view-farm').click(function() {
                    const farmId = $(this).data('id');
                    viewFarmDetails(farmId);
                });

                $('.edit-farm').click(function() {
                    const farmId = $(this).data('id');
                    showFormForEdit(farmId);
                });

                $('.delete-farm').click(function() {
                    const farmId = $(this).data('id');
                    const farmName = $(this).data('name');
                    showDeleteConfirmation(farmId, farmName);
                });
            }

            // Function to show form for adding a new farm
            function showFormForAdd() {
                $('#formTitle').text('Add New Farm');
                $('#farmId').val('');
                $('#farmForm')[0].reset();
                $('#farmFormContainer').slideDown();
                $('#name').focus();
            }

            // Function to show form for editing a farm
            function showFormForEdit(farmId) {
            $('#formTitle').text('Edit Farm');

            $.ajax({
                url: API_BASE_URL + 'farms/' + farmId + '/',
                type: 'GET',
                headers: {
                    'Authorization': 'Token ' + getToken(),
                    'X-CSRFToken': getCSRFToken() // ✅ Include CSRF Token
                },
                success: function(farm) {
                    $('#farmId').val(farm.id);
                    $('#name').val(farm.name);
                    $('#location').val(farm.location);
                    $('#area').val(farm.area);
                    $('#farmType').val(farm.farm_type);
                    $('#farmFormContainer').slideDown();
                    $('#name').focus();
                },
                error: function(xhr) {
                    showAlert('Error loading farm details: ' + getErrorMessage(xhr), 'danger');
                }
            });
        }


            // Function to hide the form
            function hideForm() {
                $('#farmFormContainer').slideUp();
                $('#farmForm')[0].reset();
            }

            // Function to save a farm (create or update)
            function saveFarm() {
                const farmId = $('#farmId').val();
                const farmData = {
                    name: $('#name').val(),
                    location: $('#location').val(),
                    area: parseFloat($('#area').val()),
                    farm_type: $('#farmType').val(),
                    user: 6
                };

                const url = farmId ?
                    API_BASE_URL + 'farms/' + farmId + '/' :
                    API_BASE_URL + 'farmlist/';

                const method = farmId ? 'PUT' : 'POST';

                $.ajax({
                    url: url,
                    type: method,
                    contentType: 'application/json',
                    data: JSON.stringify(farmData),
                    headers: {
                        'Authorization': 'Token 5cd647b01e7b4f5abf5b509176e0b72528c3088f',
                        'Content-Type': 'application/json',
                         'X-CSRFToken': 'cilZR9GCqnExakLXfs5g9NvGCnfrzHiA',
                         'Accept': 'application/json'
                    },
                    success: function(response) {
                        hideForm();
                        loadFarms();
                        showAlert(`Farm ${farmId ? 'updated' : 'created'} successfully!`, 'success');
                    },
                    error: function(xhr) {
                        showAlert(`Error ${farmId ? 'updating' : 'creating'} farm: ` + getErrorMessage(xhr), 'danger');
                    }
                });
            }

            // Function to delete a farm
            function deleteFarm(farmId) {
                $.ajax({
                    url: API_BASE_URL + 'farms/' + farmId + '/',
                    type: 'DELETE',
                    headers: {
                        'Authorization': 'Token ' + getToken()
                    },
                    success: function() {
                        deleteModal.hide();
                        loadFarms();
                        showAlert('Farm deleted successfully!', 'success');
                    },
                    error: function(xhr) {
                        deleteModal.hide();
                        showAlert('Error deleting farm: ' + getErrorMessage(xhr), 'danger');
                    }
                });
            }

            // Function to show delete confirmation
            function showDeleteConfirmation(farmId, farmName) {
                deleteId = farmId;
                $('#deleteFarmName').text(farmName);
                deleteModal.show();
            }

            // Function to view farm details
            function viewFarmDetails(farmId) {
                $.ajax({
                    url: API_BASE_URL + 'farms/' + farmId + '/',
                    type: 'GET',
                    headers: {
                        'Authorization': 'Token ' + getToken()
                    },
                    success: function(farm) {
                        $('#detailsFarmName').text(farm.name);
                        $('#detailsLocation').text(farm.location);
                        $('#detailsArea').text(farm.area);
                        $('#detailsType').text(farm.farm_type || 'Not specified');
                        $('#detailsCreated').text(formatDate(farm.created_at));
                        $('#detailsUpdated').text(formatDate(farm.updated_at));

                        // Handle motors display
                        if (farm.motors && farm.motors.length > 0) {
                            $('#noMotorsMessage').hide();
                            renderMotors(farm.motors);
                        } else {
                            $('#noMotorsMessage').show();
                            $('#motorsContent').empty();
                        }

                        detailsModal.show();
                    },
                    error: function(xhr) {
                        showAlert('Error loading farm details: ' + getErrorMessage(xhr), 'danger');
                    }
                });
            }

            // Function to render motors in the details modal
            function renderMotors(motors) {
                const motorsList = $('#motorsContent');
                motorsList.empty();

                const motorsTable = `
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Type</th>
                                <th>Power</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${motors.map(motor => `
                                <tr>
                                    <td>${motor.name}</td>
                                    <td>${motor.type || 'N/A'}</td>
                                    <td>${motor.power || 'N/A'}</td>
                                    <td>
                                        <span class="badge bg-${motor.status === 'active' ? 'success' : 'secondary'}">
                                            ${motor.status || 'N/A'}
                                        </span>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;

                motorsList.append(motorsTable);
            }

            // Helper function to format date
            function formatDate(dateString) {
                if (!dateString) return 'N/A';
                const date = new Date(dateString);
                return date.toLocaleString();
            }

            // Function to show alerts
            function showAlert(message, type) {
                const alertHTML = `
                    <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                        ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                `;

                $('#alertContainer').html(alertHTML);

                // Auto-dismiss success alerts after 3 seconds
                if (type === 'success') {
                    setTimeout(function() {
                        $('.alert').alert('close');
                    }, 3000);
                }
            }

            // Helper function to get token from localStorage
            function getToken() {
                return localStorage.getItem('auth_token') || '';
            }

            // Helper function to extract error message
            function getErrorMessage(xhr) {
                if (xhr.responseJSON && xhr.responseJSON.detail) {
                    return xhr.responseJSON.detail;
                } else if (xhr.responseJSON && xhr.responseJSON.non_field_errors) {
                    return xhr.responseJSON.non_field_errors[0];
                } else if (xhr.responseText) {
                    try {
                        const error = JSON.parse(xhr.responseText);
                        return Object.values(error)[0];
                    } catch (e) {
                        return xhr.responseText;
                    }
                }
                return 'Unknown error occurred';
            }
        });
    </script>
</body>
</html>