<!-- Add this after the User List section -->
<div class="card mb-4">
    <div class="card-header">
        Farms
    </div>
    <div class="card-body">
        <button id="addFarmBtn" class="btn btn-success mb-3">Add New Farm</button>
        <div class="table-responsive">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>User</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="farmTable">
                    <!-- Farms will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Farm Form Modal -->
<div class="modal fade" id="farmModal" tabindex="-1" aria-labelledby="farmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="farmModalLabel">Add New Farm</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="farmForm">
                    <input type="hidden" id="farmId">
                    <div class="mb-3">
                        <label for="farmName" class="form-label">Farm Name</label>
                        <input type="text" class="form-control" id="farmName" required>
                    </div>
                    <div class="mb-3">
                        <label for="farmUser" class="form-label">User</label>
                        <select class="form-select" id="farmUser" required>
                            <!-- Users will be populated here -->
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveFarmBtn">Save</button>
            </div>
        </div>
    </div>
</div>

<!-- Motor Form Modal -->
<div class="modal fade" id="motorModal" tabindex="-1" aria-labelledby="motorModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="motorModalLabel">Add Motor to Farm</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="motorForm">
                    <input type="hidden" id="motorFarmId">
                    <div class="mb-3">
                        <label for="motorName" class="form-label">Motor Name</label>
                        <input type="text" class="form-control" id="motorName" required>
                    </div>
                    <div class="mb-3">
                        <label for="motorValves" class="form-label">Number of Valves</label>
                        <input type="number" class="form-control" id="motorValves" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveMotorBtn">Save</button>
            </div>
        </div>
    </div>
</div>

// Global variables for farm and motor management
let currentFarmId = null;
const farmModal = new bootstrap.Modal(document.getElementById('farmModal'));
const motorModal = new bootstrap.Modal(document.getElementById('motorModal'));

// Fetch all farms
function fetchFarms() {
    $.ajax({
        url: '/farms/',
        type: 'GET',
        dataType: 'json',
        success: function(data) {
            renderFarmTable(data);
        },
        error: function(xhr) {
            showNotification('Error', 'Failed to load farms: ' + xhr.statusText, 'danger');
        }
    });
}

// Render farm table
function renderFarmTable(farms) {
    const farmTable = document.getElementById('farmTable');
    farmTable.innerHTML = '';

    farms.forEach(farm => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${farm.id}</td>
            <td>${farm.name}</td>
            <td>${farm.user.username}</td>
            <td>
                <button class="btn btn-sm btn-info add-motor" data-id="${farm.id}">Add Motor</button>
                <button class="btn btn-sm btn-warning edit-farm" data-id="${farm.id}">Edit</button>
                <button class="btn btn-sm btn-danger delete-farm" data-id="${farm.id}">Delete</button>
            </td>
        `;
        farmTable.appendChild(row);
    });

    // Add event listeners to buttons
    document.querySelectorAll('.add-motor').forEach(button => {
        button.addEventListener('click', function(e) {
            e.stopPropagation();
            const farmId = this.getAttribute('data-id');
            showMotorForm(farmId);
        });
    });

    document.querySelectorAll('.edit-farm').forEach(button => {
        button.addEventListener('click', function(e) {
            e.stopPropagation();
            const farmId = this.getAttribute('data-id');
            fetchFarmDetails(farmId);
        });
    });

    document.querySelectorAll('.delete-farm').forEach(button => {
        button.addEventListener('click', function(e) {
            e.stopPropagation();
            const farmId = this.getAttribute('data-id');
            showDeleteFarmConfirmation(farmId);
        });
    });
}

// Show motor form
function showMotorForm(farmId) {
    currentFarmId = farmId;
    document.getElementById('motorFarmId').value = farmId;
    motorModal.show();
}

// Fetch farm details for editing
function fetchFarmDetails(farmId) {
    $.ajax({
        url: `/farms/${farmId}/`,
        type: 'GET',
        dataType: 'json',
        success: function(farm) {
            populateFarmForm(farm);
            currentFarmId = farm.id;
            document.getElementById('farmModalLabel').textContent = 'Edit Farm';
            farmModal.show();
        },
        error: function(xhr) {
            showNotification('Error', 'Failed to load farm details: ' + xhr.statusText, 'danger');
        }
    });
}

// Populate farm form for editing
function populateFarmForm(farm) {
    document.getElementById('farmId').value = farm.id;
    document.getElementById('farmName').value = farm.name;
    document.getElementById('farmUser').value = farm.user.id;
}

// Show delete farm confirmation
function showDeleteFarmConfirmation(farmId) {
    currentFarmId = farmId;
    confirmModal.show();
}

// Create new farm
function createFarm(farmData) {
    $.ajax({
        url: '/farms/',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(farmData),
        headers: {
            'X-CSRFToken': getCsrfToken()
        },
        success: function() {
            farmModal.hide();
            showNotification('Success', 'Farm created successfully');
            fetchFarms();
        },
        error: function(xhr) {
            showNotification('Error', 'Failed to create farm: ' + xhr.responseText, 'danger');
        }
    });
}

// Update existing farm
function updateFarm(farmId, farmData) {
    $.ajax({
        url: `/farms/${farmId}/`,
        type: 'PUT',
        contentType: 'application/json',
        data: JSON.stringify(farmData),
        headers: {
            'X-CSRFToken': getCsrfToken()
        },
        success: function() {
            farmModal.hide();
            showNotification('Success', 'Farm updated successfully');
            fetchFarms();
        },
        error: function(xhr) {
            showNotification('Error', 'Failed to update farm: ' + xhr.responseText, 'danger');
        }
    });
}

// Delete farm
function deleteFarm(farmId) {
    $.ajax({
        url: `/farms/${farmId}/`,
        type: 'DELETE',
        headers: {
            'X-CSRFToken': getCsrfToken()
        },
        success: function() {
            confirmModal.hide();
            showNotification('Success', 'Farm deleted successfully');
            fetchFarms();
        },
        error: function(xhr) {
            showNotification('Error', 'Failed to delete farm: ' + xhr.statusText, 'danger');
        }
    });
}

// Gather farm form data
function gatherFarmFormData() {
    return {
        name: document.getElementById('farmName').value,
        user: document.getElementById('farmUser').value
    };
}

// Gather motor form data
function gatherMotorFormData() {
    return {
        name: document.getElementById('motorName').value,
        valves: document.getElementById('motorValves').value,
        farm: currentFarmId
    };
}

// Initialize event listeners for farms and motors
function initializeFarmAndMotorListeners() {
    // Add farm button
    document.getElementById('addFarmBtn').addEventListener('click', function() {
        resetFarmForm();
        document.getElementById('farmModalLabel').textContent = 'Add New Farm';
        farmModal.show();
    });

    // Save farm button
    document.getElementById('saveFarmBtn').addEventListener('click', function() {
        const farmData = gatherFarmFormData();
        if (currentFarmId) {
            updateFarm(currentFarmId, farmData);
        } else {
            createFarm(farmData);
        }
    });

    // Save motor button
    document.getElementById('saveMotorBtn').addEventListener('click', function() {
        const motorData = gatherMotorFormData();
        createMotor(motorData);
    });

    // Form validation for farm form
    document.getElementById('farmForm').addEventListener('submit', function(e) {
        e.preventDefault();
        document.getElementById('saveFarmBtn').click();
    });

    // Form validation for motor form
    document.getElementById('motorForm').addEventListener('submit', function(e) {
        e.preventDefault();
        document.getElementById('saveMotorBtn').click();
    });
}

// Reset farm form
function resetFarmForm() {
    document.getElementById('farmForm').reset();
    document.getElementById('farmId').value = '';
    currentFarmId = null;
}

// Initialize the page with farms and motors
function init() {
    fetchUsers();
    fetchFarms();
    initializeEventListeners();
    initializeFarmAndMotorListeners();
}

// Start the application
$(document).ready(function() {
    init();
});