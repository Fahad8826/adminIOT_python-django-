<!--<!DOCTYPE html>-->
<!--<html lang="en">-->
<!--<head>-->
<!--    <meta charset="UTF-8">-->
<!--    <meta name="viewport" content="width=device-width, initial-scale=1.0">-->
<!--    <meta name="csrf-token" content="{{ csrf_token }}">-->

<!--    <title>Farm Management System</title>-->
<!--    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">-->
<!--    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">-->
<!--    <style>-->
<!--        .farm-card {-->
<!--            transition: transform 0.3s;-->
<!--            margin-bottom: 20px;-->
<!--        }-->
<!--        .farm-card:hover {-->
<!--            transform: translateY(-5px);-->
<!--            box-shadow: 0 10px 20px rgba(0,0,0,0.1);-->
<!--        }-->
<!--        .action-buttons {-->
<!--            display: flex;-->
<!--            gap: 10px;-->
<!--        }-->
<!--        .page-header {-->
<!--            background-color: #f8f9fa;-->
<!--            padding: 20px 0;-->
<!--            margin-bottom: 30px;-->
<!--            border-bottom: 1px solid #e9ecef;-->
<!--        }-->
<!--        .empty-state {-->
<!--            text-align: center;-->
<!--            padding: 40px 0;-->
<!--        }-->
<!--        .form-section {-->
<!--            background-color: #f8f9fa;-->
<!--            padding: 20px;-->
<!--            border-radius: 5px;-->
<!--            margin-bottom: 30px;-->
<!--        }-->
<!--    </style>-->
<!--</head>-->
<!--<body>-->
<!--    &lt;!&ndash; Header &ndash;&gt;-->
<!--    <div class="page-header">-->
<!--        <div class="container">-->
<!--            <div class="d-flex justify-content-between align-items-center">-->
<!--                <h1><i class="fas fa-tractor me-2"></i>Farm Management</h1>-->
<!--                <button id="addFarmBtn" class="btn btn-primary">-->
<!--                    <i class="fas fa-plus me-2"></i>Add New Farm-->
<!--                </button>-->
<!--            </div>-->
<!--        </div>-->
<!--    </div>-->

<!--    <div class="container">-->
<!--        &lt;!&ndash; Alert Messages &ndash;&gt;-->
<!--        <div id="alertContainer"></div>-->

<!--        &lt;!&ndash; Add/Edit Farm Form &ndash;&gt;-->
<!--        <div id="farmFormContainer" class="form-section mb-4" style="display: none;">-->
<!--            <h3 id="formTitle">Add New Farm</h3>-->
<!--            <form id="farmForm">-->
<!--                <input type="hidden" id="farmId">-->
<!--                <div class="row">-->
<!--                    <div class="col-md-6 mb-3">-->
<!--                        <label for="name" class="form-label">Farm Name</label>-->
<!--                        <input type="text" class="form-control" id="name" required>-->
<!--                    </div>-->
<!--                    <div class="col-md-6 mb-3">-->
<!--                        <label for="location" class="form-label">Location</label>-->
<!--                        <input type="text" class="form-control" id="location" required>-->
<!--                    </div>-->
<!--                </div>-->
<!--                <div class="row">-->
<!--                    <div class="col-md-6 mb-3">-->
<!--                        <label for="area" class="form-label">Area (acres)</label>-->
<!--                        <input type="number" step="0.01" class="form-control" id="area" required>-->
<!--                    </div>-->
<!--                    <div class="col-md-6 mb-3">-->
<!--                        <label for="farmType" class="form-label">Farm Type</label>-->
<!--                        <input type="text" class="form-control" id="farmType">-->
<!--                    </div>-->
<!--                </div>-->
<!--                <div class="d-flex justify-content-end gap-2">-->
<!--                    <button type="button" id="cancelForm" class="btn btn-secondary">Cancel</button>-->
<!--                    <button type="submit" class="btn btn-primary">Save Farm</button>-->
<!--                </div>-->
<!--            </form>-->
<!--        </div>-->

<!--        &lt;!&ndash; Farms List Section &ndash;&gt;-->
<!--        <div class="row" id="farmsList">-->
<!--            &lt;!&ndash; Farms will be loaded here &ndash;&gt;-->
<!--            <div class="col-12 empty-state" id="emptyState">-->
<!--                <div class="text-center">-->
<!--                    <i class="fas fa-seedling fa-4x text-muted mb-3"></i>-->
<!--                    <h3>No Farms Found</h3>-->
<!--                    <p class="text-muted">Create your first farm by clicking the "Add New Farm" button above.</p>-->
<!--                </div>-->
<!--            </div>-->
<!--        </div>-->
<!--    </div>-->

<!--    &lt;!&ndash; Delete Confirmation Modal &ndash;&gt;-->
<!--    <div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">-->
<!--        <div class="modal-dialog">-->
<!--            <div class="modal-content">-->
<!--                <div class="modal-header">-->
<!--                    <h5 class="modal-title">Confirm Delete</h5>-->
<!--                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>-->
<!--                </div>-->
<!--                <div class="modal-body">-->
<!--                    Are you sure you want to delete <span id="deleteFarmName"></span>? This action cannot be undone.-->
<!--                </div>-->
<!--                <div class="modal-footer">-->
<!--                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>-->
<!--                    <button type="button" class="btn btn-danger" id="confirmDelete">Delete</button>-->
<!--                </div>-->
<!--            </div>-->
<!--        </div>-->
<!--    </div>-->

<!--    &lt;!&ndash; Farm Details Modal &ndash;&gt;-->
<!--    <div class="modal fade" id="detailsModal" tabindex="-1" aria-hidden="true">-->
<!--        <div class="modal-dialog modal-lg">-->
<!--            <div class="modal-content">-->
<!--                <div class="modal-header">-->
<!--                    <h5 class="modal-title" id="detailsFarmName">Farm Details</h5>-->
<!--                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>-->
<!--                </div>-->
<!--                <div class="modal-body">-->
<!--                    <div class="row">-->
<!--                        <div class="col-md-6">-->
<!--                            <p><strong>Location:</strong> <span id="detailsLocation"></span></p>-->
<!--                            <p><strong>Area:</strong> <span id="detailsArea"></span> acres</p>-->
<!--                            <p><strong>Farm Type:</strong> <span id="detailsType"></span></p>-->
<!--                        </div>-->
<!--                        <div class="col-md-6">-->
<!--                            <p><strong>Created:</strong> <span id="detailsCreated"></span></p>-->
<!--                            <p><strong>Last Updated:</strong> <span id="detailsUpdated"></span></p>-->
<!--                        </div>-->
<!--                    </div>-->

<!--                    <hr>-->
<!--                    <h5>Motors</h5>-->
<!--                    <div id="motorsList">-->
<!--                        <p class="text-muted" id="noMotorsMessage">No motors associated with this farm.</p>-->
<!--                        <div id="motorsContent"></div>-->
<!--                    </div>-->
<!--                </div>-->
<!--                <div class="modal-footer">-->
<!--                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>-->
<!--                </div>-->
<!--            </div>-->
<!--        </div>-->
<!--    </div>-->

<!--    &lt;!&ndash; Scripts &ndash;&gt;-->
<!--    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>-->
<!--    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>-->
<!--    <script>-->

<!--        $(document).ready(function() {-->
<!--            const token = localStorage.getItem("authToken");-->
<!--            console.log("Stored Token:", localStorage.getItem("authToken"));-->
<!--            function getCSRFToken() {-->
<!--                return document.querySelector('meta[name="csrf-token"]').getAttribute('content');-->
<!--            }-->


<!--            // Global variables-->
<!--            let deleteId = null;-->
<!--            const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));-->
<!--            const detailsModal = new bootstrap.Modal(document.getElementById('detailsModal'));-->

<!--            // API base URL - All farm API endpoints are under this prefix-->
<!--            const API_BASE_URL = '/farm/';-->

<!--            // Load farms on page load-->
<!--            loadFarms();-->

<!--            // Add Farm button click handler-->
<!--            $('#addFarmBtn').click(function() {-->
<!--                showFormForAdd();-->
<!--            });-->

<!--            // Cancel form button click handler-->
<!--            $('#cancelForm').click(function() {-->
<!--                hideForm();-->
<!--            });-->

<!--            // Farm form submit handler-->
<!--            $('#farmForm').submit(function(e) {-->
<!--                e.preventDefault();-->
<!--                saveFarm();-->
<!--            });-->

<!--            // Confirm delete button click handler-->
<!--            $('#confirmDelete').click(function() {-->
<!--                if (deleteId) {-->
<!--                    deleteFarm(deleteId);-->
<!--                }-->
<!--            });-->

<!--            // Function to load all farms-->
<!--            function loadFarms() {-->
<!--                $.ajax({-->
<!--                    url: API_BASE_URL + 'farmlist/',-->
<!--                    type: 'GET',-->
<!--                    headers: {-->
<!--                        'Authorization': 'Token 5cd647b01e7b4f5abf5b509176e0b72528c3088f',-->
<!--                        'Content-Type': 'application/json',-->
<!--                         'X-CSRFToken': 'cilZR9GCqnExakLXfs5g9NvGCnfrzHiA',-->
<!--                         'Accept': 'application/json'-->
<!--                    },-->
<!--                    success: function(data) {-->
<!--                        renderFarms(data);-->
<!--                    },-->
<!--                    error: function(xhr) {-->
<!--                        showAlert('Error loading farms: ' + getErrorMessage(xhr), 'danger');-->
<!--                    }-->
<!--                });-->
<!--            }-->

<!--            // Function to render farms in UI-->
<!--            function renderFarms(farms) {-->
<!--                const farmsList = $('#farmsList');-->
<!--                farmsList.empty();-->

<!--                if (farms.length === 0) {-->
<!--                    $('#emptyState').show();-->
<!--                    return;-->
<!--                }-->

<!--                $('#emptyState').hide();-->

<!--                farms.forEach(function(farm) {-->
<!--                    const farmCard = `-->
<!--                        <div class="col-md-4">-->
<!--                            <div class="card farm-card">-->
<!--                                <div class="card-body">-->
<!--                                    <h5 class="card-title">${farm.name}</h5>-->
<!--                                    <p class="card-text">-->
<!--                                        <i class="fas fa-map-marker-alt me-1"></i> ${farm.location}<br>-->
<!--                                        <i class="fas fa-ruler-combined me-1"></i> ${farm.area} acres<br>-->
<!--                                        <i class="fas fa-tag me-1"></i> ${farm.farm_type || 'Not specified'}-->
<!--                                    </p>-->
<!--                                    <div class="action-buttons">-->
<!--                                        <button class="btn btn-sm btn-info view-farm" data-id="${farm.id}">-->
<!--                                            <i class="fas fa-eye"></i> View-->
<!--                                        </button>-->
<!--                                        <button class="btn btn-sm btn-warning edit-farm" data-id="${farm.id}">-->
<!--                                            <i class="fas fa-edit"></i> Edit-->
<!--                                        </button>-->
<!--                                        <button class="btn btn-sm btn-danger delete-farm" data-id="${farm.id}" data-name="${farm.name}">-->
<!--                                            <i class="fas fa-trash"></i> Delete-->
<!--                                        </button>-->
<!--                                    </div>-->
<!--                                </div>-->
<!--                                <div class="card-footer text-muted">-->
<!--                                    <small>Last updated: ${formatDate(farm.updated_at)}</small>-->
<!--                                </div>-->
<!--                            </div>-->
<!--                        </div>-->
<!--                    `;-->
<!--                    farmsList.append(farmCard);-->
<!--                });-->

<!--                // Attach event handlers to buttons-->
<!--                $('.view-farm').click(function() {-->
<!--                    const farmId = $(this).data('id');-->
<!--                    viewFarmDetails(farmId);-->
<!--                });-->

<!--                $('.edit-farm').click(function() {-->
<!--                    const farmId = $(this).data('id');-->
<!--                    showFormForEdit(farmId);-->
<!--                });-->

<!--                $('.delete-farm').click(function() {-->
<!--                    const farmId = $(this).data('id');-->
<!--                    const farmName = $(this).data('name');-->
<!--                    showDeleteConfirmation(farmId, farmName);-->
<!--                });-->
<!--            }-->

<!--            // Function to show form for adding a new farm-->
<!--            function showFormForAdd() {-->
<!--                $('#formTitle').text('Add New Farm');-->
<!--                $('#farmId').val('');-->
<!--                $('#farmForm')[0].reset();-->
<!--                $('#farmFormContainer').slideDown();-->
<!--                $('#name').focus();-->
<!--            }-->

<!--            // Function to show form for editing a farm-->
<!--            function showFormForEdit(farmId) {-->
<!--            $('#formTitle').text('Edit Farm');-->

<!--            $.ajax({-->
<!--                url: API_BASE_URL + 'farms/' + farmId + '/',-->
<!--                type: 'GET',-->
<!--                headers: {-->
<!--                    'Authorization': 'Token ' + getToken(),-->
<!--                    'X-CSRFToken': getCSRFToken() // âœ… Include CSRF Token-->
<!--                },-->
<!--                success: function(farm) {-->
<!--                    $('#farmId').val(farm.id);-->
<!--                    $('#name').val(farm.name);-->
<!--                    $('#location').val(farm.location);-->
<!--                    $('#area').val(farm.area);-->
<!--                    $('#farmType').val(farm.farm_type);-->
<!--                    $('#farmFormContainer').slideDown();-->
<!--                    $('#name').focus();-->
<!--                },-->
<!--                error: function(xhr) {-->
<!--                    showAlert('Error loading farm details: ' + getErrorMessage(xhr), 'danger');-->
<!--                }-->
<!--            });-->
<!--        }-->


<!--            // Function to hide the form-->
<!--            function hideForm() {-->
<!--                $('#farmFormContainer').slideUp();-->
<!--                $('#farmForm')[0].reset();-->
<!--            }-->

<!--            // Function to save a farm (create or update)-->
<!--            function saveFarm() {-->
<!--                const farmId = $('#farmId').val();-->
<!--                const farmData = {-->
<!--                    name: $('#name').val(),-->
<!--                    location: $('#location').val(),-->
<!--                    area: parseFloat($('#area').val()),-->
<!--                    farm_type: $('#farmType').val(),-->
<!--                    user: 6-->
<!--                };-->

<!--                const url = farmId ?-->
<!--                    API_BASE_URL + 'farms/' + farmId + '/' :-->
<!--                    API_BASE_URL + 'farmlist/';-->

<!--                const method = farmId ? 'PUT' : 'POST';-->

<!--                $.ajax({-->
<!--                    url: url,-->
<!--                    type: method,-->
<!--                    contentType: 'application/json',-->
<!--                    data: JSON.stringify(farmData),-->
<!--                    headers: {-->
<!--                        'Authorization': 'Token 5cd647b01e7b4f5abf5b509176e0b72528c3088f',-->
<!--                        'Content-Type': 'application/json',-->
<!--                         'X-CSRFToken': 'cilZR9GCqnExakLXfs5g9NvGCnfrzHiA',-->
<!--                         'Accept': 'application/json'-->
<!--                    },-->
<!--                    success: function(response) {-->
<!--                        hideForm();-->
<!--                        loadFarms();-->
<!--                        showAlert(`Farm ${farmId ? 'updated' : 'created'} successfully!`, 'success');-->
<!--                    },-->
<!--                    error: function(xhr) {-->
<!--                        showAlert(`Error ${farmId ? 'updating' : 'creating'} farm: ` + getErrorMessage(xhr), 'danger');-->
<!--                    }-->
<!--                });-->
<!--            }-->

<!--            // Function to delete a farm-->
<!--            function deleteFarm(farmId) {-->
<!--                $.ajax({-->
<!--                    url: API_BASE_URL + 'farms/' + farmId + '/',-->
<!--                    type: 'DELETE',-->
<!--                    headers: {-->
<!--                        'Authorization': 'Token ' + getToken()-->
<!--                    },-->
<!--                    success: function() {-->
<!--                        deleteModal.hide();-->
<!--                        loadFarms();-->
<!--                        showAlert('Farm deleted successfully!', 'success');-->
<!--                    },-->
<!--                    error: function(xhr) {-->
<!--                        deleteModal.hide();-->
<!--                        showAlert('Error deleting farm: ' + getErrorMessage(xhr), 'danger');-->
<!--                    }-->
<!--                });-->
<!--            }-->

<!--            // Function to show delete confirmation-->
<!--            function showDeleteConfirmation(farmId, farmName) {-->
<!--                deleteId = farmId;-->
<!--                $('#deleteFarmName').text(farmName);-->
<!--                deleteModal.show();-->
<!--            }-->

<!--            // Function to view farm details-->
<!--            function viewFarmDetails(farmId) {-->
<!--                $.ajax({-->
<!--                    url: API_BASE_URL + 'farms/' + farmId + '/',-->
<!--                    type: 'GET',-->
<!--                    headers: {-->
<!--                        'Authorization': 'Token ' + getToken()-->
<!--                    },-->
<!--                    success: function(farm) {-->
<!--                        $('#detailsFarmName').text(farm.name);-->
<!--                        $('#detailsLocation').text(farm.location);-->
<!--                        $('#detailsArea').text(farm.area);-->
<!--                        $('#detailsType').text(farm.farm_type || 'Not specified');-->
<!--                        $('#detailsCreated').text(formatDate(farm.created_at));-->
<!--                        $('#detailsUpdated').text(formatDate(farm.updated_at));-->

<!--                        // Handle motors display-->
<!--                        if (farm.motors && farm.motors.length > 0) {-->
<!--                            $('#noMotorsMessage').hide();-->
<!--                            renderMotors(farm.motors);-->
<!--                        } else {-->
<!--                            $('#noMotorsMessage').show();-->
<!--                            $('#motorsContent').empty();-->
<!--                        }-->

<!--                        detailsModal.show();-->
<!--                    },-->
<!--                    error: function(xhr) {-->
<!--                        showAlert('Error loading farm details: ' + getErrorMessage(xhr), 'danger');-->
<!--                    }-->
<!--                });-->
<!--            }-->

<!--            // Function to render motors in the details modal-->
<!--            function renderMotors(motors) {-->
<!--                const motorsList = $('#motorsContent');-->
<!--                motorsList.empty();-->

<!--                const motorsTable = `-->
<!--                    <table class="table table-striped">-->
<!--                        <thead>-->
<!--                            <tr>-->
<!--                                <th>Name</th>-->
<!--                                <th>Type</th>-->
<!--                                <th>Power</th>-->
<!--                                <th>Status</th>-->
<!--                            </tr>-->
<!--                        </thead>-->
<!--                        <tbody>-->
<!--                            ${motors.map(motor => `-->
<!--                                <tr>-->
<!--                                    <td>${motor.name}</td>-->
<!--                                    <td>${motor.type || 'N/A'}</td>-->
<!--                                    <td>${motor.power || 'N/A'}</td>-->
<!--                                    <td>-->
<!--                                        <span class="badge bg-${motor.status === 'active' ? 'success' : 'secondary'}">-->
<!--                                            ${motor.status || 'N/A'}-->
<!--                                        </span>-->
<!--                                    </td>-->
<!--                                </tr>-->
<!--                            `).join('')}-->
<!--                        </tbody>-->
<!--                    </table>-->
<!--                `;-->

<!--                motorsList.append(motorsTable);-->
<!--            }-->

<!--            // Helper function to format date-->
<!--            function formatDate(dateString) {-->
<!--                if (!dateString) return 'N/A';-->
<!--                const date = new Date(dateString);-->
<!--                return date.toLocaleString();-->
<!--            }-->

<!--            // Function to show alerts-->
<!--            function showAlert(message, type) {-->
<!--                const alertHTML = `-->
<!--                    <div class="alert alert-${type} alert-dismissible fade show" role="alert">-->
<!--                        ${message}-->
<!--                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>-->
<!--                    </div>-->
<!--                `;-->

<!--                $('#alertContainer').html(alertHTML);-->

<!--                // Auto-dismiss success alerts after 3 seconds-->
<!--                if (type === 'success') {-->
<!--                    setTimeout(function() {-->
<!--                        $('.alert').alert('close');-->
<!--                    }, 3000);-->
<!--                }-->
<!--            }-->

<!--            // Helper function to get token from localStorage-->
<!--            function getToken() {-->
<!--                return localStorage.getItem('auth_token') || '';-->
<!--            }-->

<!--            // Helper function to extract error message-->
<!--            function getErrorMessage(xhr) {-->
<!--                if (xhr.responseJSON && xhr.responseJSON.detail) {-->
<!--                    return xhr.responseJSON.detail;-->
<!--                } else if (xhr.responseJSON && xhr.responseJSON.non_field_errors) {-->
<!--                    return xhr.responseJSON.non_field_errors[0];-->
<!--                } else if (xhr.responseText) {-->
<!--                    try {-->
<!--                        const error = JSON.parse(xhr.responseText);-->
<!--                        return Object.values(error)[0];-->
<!--                    } catch (e) {-->
<!--                        return xhr.responseText;-->
<!--                    }-->
<!--                }-->
<!--                return 'Unknown error occurred';-->
<!--            }-->
<!--        });-->
<!--    </script>-->
<!--</body>-->
<!--</html>-->


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Farm Management</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        .farm-row {
            cursor: pointer;
        }
        .farm-row:hover {
            background-color: #f8f9fa;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1>Farm Management</h1>

        <div class="row mb-4">
            <div class="col">
                <button id="addFarmBtn" class="btn btn-primary">
                    <i class="fas fa-plus me-2"></i>Add New Farm
                </button>
            </div>
        </div>

        <!-- Farm List -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Farms</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Name</th>
                                <th>Location</th>
                                <th>Area (acres)</th>
                                <th>Farm Type</th>
                                <th>Owner</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="farmTable">
                            <!-- Farms will be loaded here -->
                        </tbody>
                    </table>
                </div>
                <div id="loadingIndicator" class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                <div id="noFarmsMessage" class="text-center hidden">
                    <p>No farms available. Add a new farm to get started.</p>
                </div>
            </div>
        </div>

        <!-- Farm Form Modal -->
        <div class="modal fade" id="farmModal" tabindex="-1" aria-labelledby="farmModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="farmModalLabel">Add New Farm</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="farmForm">
                            <input type="hidden" id="farmId">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="name" class="form-label">Farm Name</label>
                                    <input type="text" class="form-control" id="name" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="location" class="form-label">Location</label>
                                    <input type="text" class="form-control" id="location" required>
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="area" class="form-label">Area (acres)</label>
                                    <input type="number" step="0.01" class="form-control" id="area" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="farmType" class="form-label">Farm Type</label>
                                    <input type="text" class="form-control" id="farmType">
                                </div>
                            </div>
                            <div class="row mb-3">
                                <div class="col-md-12">
                                    <label for="userId" class="form-label">Owner</label>
                                    <select class="form-select" id="userId" required>
                                        <option value="" selected disabled>Select an owner</option>
                                        <!-- User options will be loaded here -->
                                    </select>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" id="saveFarmBtn">Save</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Farm Details Modal -->
        <div class="modal fade" id="farmDetailsModal" tabindex="-1" aria-labelledby="farmDetailsModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-info text-white">
                        <h5 class="modal-title" id="farmDetailsModalLabel">Farm Details</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Name:</strong> <span id="detailName"></span></p>
                                <p><strong>Location:</strong> <span id="detailLocation"></span></p>
                                <p><strong>Area:</strong> <span id="detailArea"></span> acres</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Farm Type:</strong> <span id="detailFarmType"></span></p>
                                <p><strong>Owner:</strong> <span id="detailOwner"></span></p>
                                <p><strong>Created:</strong> <span id="detailCreated"></span></p>
                            </div>
                        </div>

                        <!-- Motors Section -->
                        <div class="mt-4">
                            <h5>Motors</h5>
                            <div class="table-responsive">
                                <table class="table table-striped table-sm">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Type</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="motorsList">
                                        <!-- Motors will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                            <div id="noMotorsMessage" class="text-center hidden">
                                <p class="text-muted">No motors available for this farm.</p>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Confirmation Modal -->
        <div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title" id="confirmModalLabel">Confirm Delete</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        Are you sure you want to delete the farm "<span id="deleteFarmName"></span>"?
                        <p class="text-danger mt-2"><small>This action cannot be undone.</small></p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Toast Notifications -->
        <div class="toast-container position-fixed bottom-0 end-0 p-3">
            <div id="notificationToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="toast-header" id="toastHeader">
                    <strong class="me-auto" id="toastTitle">Notification</strong>
                    <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body" id="toastMessage">
                    <!-- Notification message will be set here -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script>
        // Helper function to get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

        // API Endpoints
        const FARM_API_URL = '/farmlist/';
        const FARM_DETAIL_URL = '/farms/';
        const USER_API_URL = '/api/users/';  // Adjust this to your user API endpoint

        let deleteFarmId = null;
        let currentMode = 'add';

        // Show notification toast
        function showNotification(message, isSuccess = true) {
            const toast = document.getElementById('notificationToast');
            const toastTitle = document.getElementById('toastTitle');
            const toastMessage = document.getElementById('toastMessage');
            const toastHeader = document.getElementById('toastHeader');

            toastHeader.className = 'toast-header';

            if (isSuccess) {
                toastHeader.classList.add('bg-success', 'text-white');
                toastTitle.textContent = 'Success';
            } else {
                toastHeader.classList.add('bg-danger', 'text-white');
                toastTitle.textContent = 'Error';
            }

            toastMessage.textContent = message;

            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();
        }

        // Format date
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Load all farms
        function loadFarms() {
            const loadingIndicator = document.getElementById('loadingIndicator');
            const noFarmsMessage = document.getElementById('noFarmsMessage');

            loadingIndicator.classList.remove('hidden');
            noFarmsMessage.classList.add('hidden');

            fetch(FARM_API_URL, {
                method: 'GET',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to load farms');
                }
                return response.json();
            })
            .then(farms => {
                const farmTable = document.getElementById('farmTable');
                loadingIndicator.classList.add('hidden');

                farmTable.innerHTML = '';

                if (farms.length === 0) {
                    noFarmsMessage.classList.remove('hidden');
                    return;
                }

                farms.forEach(farm => {
                    const row = document.createElement('tr');
                    row.className = 'farm-row';
                    row.setAttribute('data-id', farm.id);

                    let ownerName = '-';
                    if (farm.user && typeof farm.user === 'object') {
                        ownerName = farm.user.username || farm.user.email;
                    } else if (farm.user) {
                        ownerName = farm.user.toString();
                    }

                    row.innerHTML = `
                        <td>${farm.id}</td>
                        <td>${farm.name}</td>
                        <td>${farm.location}</td>
                        <td>${farm.area}</td>
                        <td>${farm.farm_type || '-'}</td>
                        <td>${ownerName}</td>
                        <td>${formatDate(farm.created_at)}</td>
                        <td>
                            <button class="btn btn-info btn-sm view-farm" data-id="${farm.id}">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-warning btn-sm edit-farm" data-id="${farm.id}">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-danger btn-sm delete-farm" data-id="${farm.id}" data-name="${farm.name}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;

                    farmTable.appendChild(row);
                });

                // Add event listeners
                document.querySelectorAll('.view-farm').forEach(button => {
                    button.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const farmId = this.getAttribute('data-id');
                        viewFarmDetails(farmId);
                    });
                });

                document.querySelectorAll('.edit-farm').forEach(button => {
                    button.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const farmId = this.getAttribute('data-id');
                        editFarm(farmId);
                    });
                });

                document.querySelectorAll('.delete-farm').forEach(button => {
                    button.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const farmId = this.getAttribute('data-id');
                        const farmName = this.getAttribute('data-name');
                        showDeleteConfirmation(farmId, farmName);
                    });
                });

                document.querySelectorAll('.farm-row').forEach(row => {
                    row.addEventListener('click', function() {
                        const farmId = this.getAttribute('data-id');
                        viewFarmDetails(farmId);
                    });
                });
            })
            .catch(error => {
                loadingIndicator.classList.add('hidden');
                showNotification(`Error: ${error.message}`, false);
            });
        }

        // Load all users for the dropdown
        function loadUsers() {
            fetch(USER_API_URL, {
                method: 'GET',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to load users');
                }
                return response.json();
            })
            .then(users => {
                const userSelect = document.getElementById('userId');
                userSelect.innerHTML = '<option value="" selected disabled>Select an owner</option>';

                users.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = `${user.username || user.email}`;
                    userSelect.appendChild(option);
                });
            })
            .catch(error => {
                showNotification(`Error loading users: ${error.message}`, false);
            });
        }

        // View farm details
        function viewFarmDetails(farmId) {
            fetch(`${FARM_DETAIL_URL}${farmId}/`, {
                method: 'GET',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to load farm details');
                }
                return response.json();
            })
            .then(farm => {
                document.getElementById('detailName').textContent = farm.name;
                document.getElementById('detailLocation').textContent = farm.location;
                document.getElementById('detailArea').textContent = farm.area;
                document.getElementById('detailFarmType').textContent = farm.farm_type || '-';

                let ownerName = '-';
                if (farm.user && typeof farm.user === 'object') {
                    ownerName = farm.user.username || farm.user.email;
                } else if (farm.user) {
                    ownerName = farm.user.toString();
                }

                document.getElementById('detailOwner').textContent = ownerName;
                document.getElementById('detailCreated').textContent = formatDate(farm.created_at);

                // Display motors if available
                const motorsList = document.getElementById('motorsList');
                const noMotorsMessage = document.getElementById('noMotorsMessage');

                motorsList.innerHTML = '';

                if (farm.motors && farm.motors.length > 0) {
                    noMotorsMessage.classList.add('hidden');
                    farm.motors.forEach(motor => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${motor.name}</td>
                            <td>${motor.motor_type || '-'}</td>
                            <td>${motor.status || '-'}</td>
                        `;
                        motorsList.appendChild(row);
                    });
                } else {
                    noMotorsMessage.classList.remove('hidden');
                }

                // Show the modal
                const detailsModal = new bootstrap.Modal(document.getElementById('farmDetailsModal'));
                detailsModal.show();
            })
            .catch(error => {
                showNotification(`Error: ${error.message}`, false);
            });
        }

        // Edit farm
        function editFarm(farmId) {
            currentMode = 'edit';

            // Reset form
            document.getElementById('farmForm').reset();
            document.getElementById('farmId').value = farmId;

            // Change modal title
            document.getElementById('farmModalLabel').textContent = 'Edit Farm';

            fetch(`${FARM_DETAIL_URL}${farmId}/`, {
                method: 'GET',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to load farm details');
                }
                return response.json();
            })
            .then(farm => {
                // Populate form fields
                document.getElementById('name').value = farm.name;
                document.getElementById('location').value = farm.location;
                document.getElementById('area').value = farm.area;
                document.getElementById('farmType').value = farm.farm_type || '';

                // Set the user ID in the dropdown
                let userId = '';
                if (farm.user && typeof farm.user === 'object') {
                    userId = farm.user.id;
                } else if (farm.user) {
                    userId = farm.user;
                }

                // Ensure users are loaded before trying to set the dropdown value
                ensureUsersLoaded(userId);

                // Show the modal
                const farmModal = new bootstrap.Modal(document.getElementById('farmModal'));
                farmModal.show();
            })
            .catch(error => {
                showNotification(`Error: ${error.message}`, false);
            });
        }

        // Ensure users are loaded before setting dropdown value
        function ensureUsersLoaded(userId) {
            const userSelect = document.getElementById('userId');

            // If options already exist, just set the value
            if (userSelect.options.length > 1) {
                userSelect.value = userId;
                return;
            }

            // Otherwise load users and then set the value
            fetch(USER_API_URL, {
                method: 'GET',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(users => {
                userSelect.innerHTML = '<option value="" selected disabled>Select an owner</option>';

                users.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    option.textContent = `${user.username || user.email}`;
                    userSelect.appendChild(option);
                });

                userSelect.value = userId;
            })
            .catch(error => {
                showNotification(`Error loading users: ${error.message}`, false);
            });
        }

        // Show delete confirmation
        function showDeleteConfirmation(farmId, farmName) {
            deleteFarmId = farmId;
            document.getElementById('deleteFarmName').textContent = farmName;

            const confirmModal = new bootstrap.Modal(document.getElementById('confirmModal'));
            confirmModal.show();
        }

        // Save farm (create or update)
        function saveFarm() {
            const farmId = document.getElementById('farmId').value;
            const name = document.getElementById('name').value;
            const location = document.getElementById('location').value;
            const area = document.getElementById('area').value;
            const farmType = document.getElementById('farmType').value;
            const userId = document.getElementById('userId').value;

            // Validate required fields
            if (!name || !location || !area || !userId) {
                showNotification('Please fill in all required fields', false);
                return;
            }

            const farmData = {
                name: name,
                location: location,
                area: parseFloat(area),
                farm_type: farmType,
                user: parseInt(userId)
            };

            let url = FARM_API_URL;
            let method = 'POST';

            if (currentMode === 'edit') {
                url = `${FARM_DETAIL_URL}${farmId}/`;
                method = 'PUT';
            }

            fetch(url, {
                method: method,
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(farmData)
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(Object.values(data).flat().join(", "));
                    });
                }
                return response.json();
            })
            .then(data => {
                // Hide modal
                const farmModal = bootstrap.Modal.getInstance(document.getElementById('farmModal'));
                farmModal.hide();

                // Show success notification
                const message = currentMode === 'add' ? 'Farm created successfully!' : 'Farm updated successfully!';
                showNotification(message, true);

                // Reload farms
                loadFarms();
            })
            .catch(error => {
                showNotification(`Error: ${error.message}`, false);
            });
        }

        // Delete farm
        function deleteFarm() {
            if (!deleteFarmId) return;

            fetch(`${FARM_DETAIL_URL}${deleteFarmId}/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to delete farm');
                }

                // Hide confirmation modal
                const confirmModal = bootstrap.Modal.getInstance(document.getElementById('confirmModal'));
                confirmModal.hide();

                // Show success notification
                showNotification('Farm deleted successfully!', true);

                // Reset deleteFarmId
                deleteFarmId = null;

                // Reload farms
                loadFarms();
            })
            .catch(error => {
                showNotification(`Error: ${error.message}`, false);
            });
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Load farms and users
            loadFarms();
            loadUsers();

            // Add event listeners
            document.getElementById('addFarmBtn').addEventListener('click', function() {
                currentMode = 'add';
                document.getElementById('farmForm').reset();
                document.getElementById('farmId').value = '';
                document.getElementById('farmModalLabel').textContent = 'Add New Farm';

                const farmModal = new bootstrap.Modal(document.getElementById('farmModal'));
                farmModal.show();
            });

            document.getElementById('saveFarmBtn').addEventListener('click', saveFarm);
            document.getElementById('confirmDeleteBtn').addEventListener('click', deleteFarm);
        });
    </script>
</body>
</html>